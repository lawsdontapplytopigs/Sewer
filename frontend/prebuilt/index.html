<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="./elm.js" type="text/javascript"></script>
    <script src="./howler.core.min.js" type="text/javascript"></script>
    <link href="./fonts/fonts.css" rel="stylesheet">
    <link href="general.css" rel="stylesheet" type="text/plain">
</head>
<body>
    <div>
        You need to have javascript enabled for this site to render.
    </div>
    <div id="elm-node"></div>
    <script>
        let albumDir = "./albums/";

        let album0 = {
            title : "Draining Love Story",
            albumCoverSrc : albumDir + "0.jpg",
            songs : [ 
                {
                    title : "Love Is A Mighty Big Word",
                    artist : "Sewerslvt",
                    duration : 131,
                    src : "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/LoveIsAMightyBigWord.mp3"
                },
                {
                    title : "Newlove",
                    artist : "Sewerslvt",
                    duration : 359,
                    src : "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/Newlove.mp3"
                },
                {
                    title : "Yandere Complex",
                    artist : "Sewerslvt",
                    duration: 250,
                    src : "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/YandereComplex.mp3"
                },
                {
                    title : "Ecifircas",
                    artist : "Sewerslvt",
                    duration: 347,
                    src : "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/Ecifircas.mp3"
                },
                {
                    title : "Lexapro Delirium",
                    artist : "Sewerslvt",
                    duration: 435,
                    src : "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/LexaproDelirium.mp3"
                },
                {
                    title : "This Fleeting Feeling",
                    artist : "Sewerslvt",
                    duration: 211,
                    src : "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/ThisFleetingFeeling.mp3"
                },
                {
                    title : "Swinging In His Cell",
                    artist : "Sewerslvt",
                    duration: 322,
                    src : "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/SwingingInHisCell.mp3"
                },
                {
                    title : "Mr. Kill Myself",
                    artist : "Sewerslvt",
                    duration: 471,
                    src : "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/Mr.KillMyself.mp3"
                },
                {
                    title : "Down The Drain (feat. Nurtheon)",
                    artist : "Sewerslvt",
                    duration: 488,
                    src : "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/DownTheDrain.mp3"
                },
                {
                    title : "Slowdeath",
                    artist : "Sewerslvt",
                    duration: 492,
                    src : "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/Slowdeath.mp3"
                },
            ]
        };

    </script>
    <script>
        let elm = Elm.Main.init({ 
            node: document.getElementById("elm-node"),
            flags: { 
                viewportWidth : window.innerWidth,
                viewportHeight : window.innerHeight,
            }
        });
        window.onresize = () => {
            elm.ports.audioPortFromJS.send({
                type : 4,
                viewportWidth : window.innerWidth,
                viewportHeight : window.innerHeight,
            });
        };

        // unfortunately we have to do this here, since the mdgriffith/elm-ui 
        // library overrides our attributes if we do 
        // "E.htmlAttribute <| Html.Attributes.style "autofill" "email"
        // note: we do NOT want to use the mdgriffith/elm-ui function for creating
        // an email input field, because on invalid email adresses it looks 
        // super ugly. Not the library's fault, but the browser's.
        let email = document.getElementById("emailBox");
        if (email != undefined) {
            email.autofill = "email"
        };

        let Player = ( elmApp, album ) => {

            let pl = {
                howl : undefined
            };
            pl.index = 0;
            pl.songs = album.songs;
            pl.shouldShuffle = false;
            pl.shouldBePlaying = false;
            pl.shouldRepeat = false;
            // NOTE: we don't use this to actually track the amount elapsed in
            // real time of the current song. we only use this for things like
            // seeking in a track before it's been fetched, so when the user
            // clicks "play" we can start from that position
            pl.seekAmount = 0;

            // TODO: instead of just inserting this into the album, make another
            // object with the type and embed the album in there
            album.type = 1; 
            elmApp.ports.audioPortFromJS.send(album);

            pl.fetchSong = () => {
                Howler.unload();
                let song = pl.songs[pl.index];
                pl.howl = new Howl({
                    src : [ song.src ],
                    onplay : () => {
                        elmApp.ports.audioPortFromJS.send({
                            type : 0,
                            event: "SONG_PLAYING"
                        });
                        pl.sendTimeData(pl.howl.seek());
                        pl.sendSongData();
                    },
                    onload : () => {
                        elmApp.ports.audioPortFromJS.send({
                            type : 0,
                            event: "SONG_LOADED"
                        });
                        if (pl.shouldBePlaying) {
                            pl.howl.seek(pl.seekAmount);
                            pl.howl.play();
                        };
                    },
                    onend : () => {
                        elmApp.ports.audioPortFromJS.send({
                            type : 0,
                            event: "SONG_ENDED"
                        });
                        pl.next();
                    },
                    // TODO: make this work well. sometimes there's `null`s
                    // in the JSON
                    /* onstop : () => { */
                    /*     pl.shouldBePlaying = false; */
                    /* }, */
                    onpause : () => {
                        elmApp.ports.audioPortFromJS.send({
                            type : 0,
                            event: "SONG_PAUSED"
                        });
                        pl.sendTimeData(pl.howl.seek());
                        pl.sendSongData();
                    },
                    onseek : () => {
                        pl.seekAmount = pl.howl.seek();
                        pl.sendSongData();
                        pl.sendTimeData(pl.howl.seek());
                    }
                });
            };

            pl.toggleShuffle = () => {
                pl.shouldShuffle = !pl.shouldShuffle;
            };

            pl.toggleRepeat = () => {
                pl.shouldRepeat = !pl.shouldRepeat;
            };

            pl.playRandom = () => {
                pl.playAt(Math.floor(Math.random() * pl.songs.length));
            };

            pl.forceNext = () => {
                if (pl.shouldShuffle) {
                    pl.playRandom();
                } else {
                    pl.playAt(pl.index + 1);
                }
            };

            pl.next = () => {
                if (pl.shouldRepeat) {
                    pl.playAt(pl.index);
                } else if (pl.shouldShuffle) {
                    pl.playRandom();
                } else {
                    pl.playAt(pl.index + 1);
                }
            };

            pl.prev = () => {
                pl.playAt(pl.index - 1);
            };

            pl.playAt = ( ind ) => {
                pl.shouldBePlaying = true;
                /* let audio = pl.songs[pl.index].howl; */
                /* if (audio) { */
                /*     audio.stop(); */
                /* }; */
                if (ind === pl.index) {
                    if (pl.howl) {
                        pl.howl.play();
                    } else {
                        pl.fetchSong();
                    }
                    return
                };


                let index = ind;
                if (index >= pl.songs.length) {
                    index = 0;
                } else if (index < 0) {
                    index = 0;
                };
                pl.seekAmount = 0;
                pl.index = index;
                pl.sendSongData(); // we do NOT want to send time data here since
                // we don't know if there is a howl instance yet
                pl.fetchSong();
            };

            pl.play = () => {
                pl.playAt(pl.index);
            };

            pl.volume = (val) => {
                Howler.volume(val);
            };

            pl.pause = () => {
                if (!pl.howl) {
                    console.log("tried pausing, but theres no howl instance to pause");
                    return
                };
                pl.howl.pause();
                pl.shouldBePlaying = false;
            };

            pl.seek = (secs) => {
                pl.seekAmount = secs;
                if (pl.howl) {
                    pl.howl.seek(secs);
                };
                pl.sendTimeData(pl.seekAmount);
            };

            pl.togglePlay = () => {
                if (!pl.howl) {
                    pl.play();
                } else {
                    if (pl.howl.playing()) {
                        pl.pause();
                    } else {
                        pl.play();
                    };
                };
            };

            /* pl.sendCurrentSongData = () => { */
            /*     let song = pl.songs[pl.index]; */
            /*     elmApp.ports.audioPortFromJS.send({ */
            /*         title : song.title, */
            /*         artist : song.artist, */
            /*     }); */ 
            /* }; */
            pl.sendSongData = () => {
                let song = pl.songs[pl.index];
                elmApp.ports.audioPortFromJS.send({
                    type : 3,
                    title : song.title,
                    artist : song.artist,
                    duration : song.duration,
                });
            };

            // we want to parameterize the seek amount because sometimes we don't
            // want to send the seek amount of the howl instance (because there 
            // isn't one. we want to send the seek amount that WE stored so it'll
            // be displayed properly in the media player. this way the user can 
            // seek into a song before it's even loaded
            // TODO: I just realized: we can't do it unless we send some duration 
            // and also some "isPlaying" state. so i'll have to somehow do that 

            pl.sendTimeData = ( seekAMT ) => {
                if (pl.howl) {
                    elmApp.ports.audioPortFromJS.send({
                        type : 2,
                        elapsed : Math.floor(seekAMT),
                        duration : pl.howl.duration(),
                        isPlaying : pl.howl.playing(),
                    });
                };
            };
            // send song data right when we pass a new album
            pl.sendSongData();
            // For some reason this causes a cyclic object value type error
            setInterval(() => {
                /* let audio = pl.songs[pl.index].howl; */
                pl.sendSongData();
                if (pl.howl) {
                    pl.sendTimeData(pl.howl.seek());
                };
            }, 1000);

            return pl;
        };

        let player = Player(elm, album0);
        elm.ports.audioPortToJS.subscribe((msg) => {
            console.log(msg);
            if (msg === "TOGGLE_PLAY") {
                console.log("should toggle play");
                player.togglePlay();
            } else if (msg === "PLAY") {
                player.play();
            } else if (msg === "PAUSE") {
                player.pause();
            } else if (msg === "NEXT") {
                player.forceNext();
            } else if (msg === "TOGGLE_SHUFFLE") {
                player.toggleShuffle();
            } else if (msg === "TOGGLE_REPEAT") {
                player.toggleRepeat();
            } else if (msg === "PREV") {
                player.prev();
            // i shouldn't be doing this, but it'll get the job done
            } else if (msg.seek !== undefined){
                console.log("should seek");
                player.seek(msg.seek);
            } else if (msg.playSongAt !== undefined) {
                console.log("playing song at " + msg.playSongAt);
                player.playAt(msg.playSongAt);
            } else {
                console.log("something didn't go as planned...")
                console.log(msg);
            };
        });
        </script>
</body>
<link href="./fonts/pleaseWork.css" rel="stylesheet" type="text/css">
</html>
<script>
                    /* { */
                    /*     metaData: data("Love Is A Mighty Big Word"), */
                    /*     duration : 131, */
                    /*     url: "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/LoveIsAMightyBigWord.mp3", */
                    /* }, */
                    /* { */
                    /*     metaData: data("Newlove"), */
                    /*     duration : 359, */
                    /*     url: "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/Newlove.mp3", */
                    /* }, */
                    /* { */
                    /*     metaData: data("Yandere Complex"), */
                    /*     duration: 250, */
                    /*     url: "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/YandereComplex.mp3", */
                    /* }, */
                    /* { */
                    /*     metaData: data("Ecifircas"), */
                    /*     duration: 347, */
                    /*     url: "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/Ecifircas.mp3", */
                    /* }, */
                    /* { */
                    /*     metaData: data("Lexapro Delirium"), */
                    /*     duration: 435, */
                    /*     url: "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/LexaproDelirium.mp3", */
                    /* }, */
                    /* { */
                    /*     metaData: data("This Fleeting Feeling"), */
                    /*     duration: 211, */
                    /*     url: "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/ThisFleetingFeeling.mp3", */
                    /* }, */
                    /* { */
                    /*     metaData: data("Swinging In His Cell"), */
                    /*     duration: 322, */
                    /*     url: "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/SwingingInHisCell.mp3", */
                    /* }, */
                    /* { */
                    /*     metaData: data("Mr. Kill Myself"), */
                    /*     duration: 471, */
                    /*     url: "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/Mr.KillMyself.mp3", */
                    /* }, */
                    /* { */
                    /*     metaData: data("Down The Drain (feat. Nurtheon)"), */
                    /*     duration: 488, */
                    /*     url: "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/DownTheDrain.mp3", */
                    /* }, */
                    /* { */
                    /*     metaData: data("Slowdeath"), */
                    /*     duration: 492, */
                    /*     url: "https://cdn.jsdelivr.net/gh/lawsdontapplytopigs/Sewer@4236763f91e00d6f6fa21a2316a7aefe79de1f84/frontend/prebuilt/albums/DrainingLoveStory/Slowdeath.mp3", */
                    /* }, */
</script>
